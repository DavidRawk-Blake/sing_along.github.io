<!doctype html>
<html lang="en">

<head>
  <title>Sing along</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, width=device-width">
</head>

<body style="background-color: turquoise;">
  <main>
    <h1>Sing along</h1>
    play two songs at once
    <br>
    <audio controls>
      <source src="song1.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
    <br>
    <audio controls>
      <source src="song2.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
  </main>

  <div>
    Listen to the microphone and make the background color change with the volume
    <br>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <div id="volume">Volume: 0</div>
  </div>

  <div>
    When I press a button, have the computer say something
    <br>
    <button id="speak-button">Speak</button>
  </div>

  <div>
    detect when a word is said
    <br>
    <button id="start-speech">Start Speech Recognition</button>
    <button id="stop-speech">Stop Speech Recognition</button>
    <div id="transcript">Transcript: </div>
  </div>

  <div>
    detext when a specific word is said
    <br>
    words: hello
    <div id="detected-word">Detected word: </div>
    <button id="start-detect-word">start detecting</button>
    <button id="stop-detect-word">Stop detecting</button>

    <script>
      // Function to generate trigrams from a string
      function generateTrigrams(str) {
        const trigrams = new Set();
        // Pad the string with spaces to capture leading/trailing trigrams
        const paddedStr = " " + str + " ";
        for (let i = 0; i < paddedStr.length - 2; i++) {
          trigrams.add(paddedStr.substring(i, i + 3));
        }
        return trigrams;
      }


      // Function to calculate trigram similarity
      function calculateTrigramSimilarity(str1, str2) {
        if (str1 === str2) return 1.0; // Identical strings have 100% similarity

        const trigrams1 = generateTrigrams(str1);
        const trigrams2 = generateTrigrams(str2);

        let commonTrigramsCount = 0;
        for (const trigram of trigrams1) {
          if (trigrams2.has(trigram)) {
            commonTrigramsCount++;
          }
        }

        const totalUniqueTrigrams = trigrams1.size + trigrams2.size - commonTrigramsCount;

        if (totalUniqueTrigrams === 0) return 0.0; // Avoid division by zero

        return commonTrigramsCount / totalUniqueTrigrams;
      }


      // Check for browser compatibility and use prefixed versions if necessary
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const SpeechRecognitionEvent = window.SpeechRecognitionEvent || window.webkitSpeechRecognitionEvent;

      // Create a new SpeechRecognition object
      const recognition = new SpeechRecognition();
      // Set properties for the recognition object
      recognition.lang = 'en-US'; // Set the language for recognition
      recognition.interimResults = true; // Get interim results as well
      recognition.maxAlternatives = 1; // Get only the most likely alternative
      recognition.continuous = true; // Keep recognizing until stopped

      // Get references to HTML elements for displaying results and controlling recognition
      const output = document.querySelector('#detected-word');
      const startBtn = document.querySelector('#start-detect-word');

      // Event listener for when speech recognition results are available
      recognition.addEventListener('result', (event) => {
        const last = event.results.length - 1;
        const command = event.results[last][0].transcript;
        output.textContent = 'You said: ' + command;
        console.log('Confidence: ' + event.results[last][0].confidence);
        console.log('Detected command:', command);
        const targetWord = 'ribbit';
        const similarity = calculateTrigramSimilarity(command.toLowerCase(), targetWord.toLowerCase());
        console.log(`Trigram similarity with "${command}" to "${targetWord}":`, similarity);
      });

      // Event listener for when the speech recognition service disconnects
      recognition.addEventListener('end', () => {
        console.log('Speech recognition service disconnected.');
      });

      // Event listener for errors during speech recognition
      recognition.addEventListener('error', (event) => {
        output.textContent = 'Error occurred in speech recognition: ' + event.error;
        console.error('Speech recognition error:', event.error);
      });

      // Event listener for the start button to initiate speech recognition
      startBtn.addEventListener('click', () => {
        recognition.start();
        output.textContent = 'Listening...';
        console.log('Speech recognition started.');
      });
    </script>
  </div>

</body>
<script>
  // Text to Speech
  const speakButton = document.getElementById('speak-button');
  speakButton.addEventListener('click', () => {
    const speech = new p5.Speech(); // new P5.Speech object
    speech.speak('Hello! This is a test.');
  });


  // // Speech Recognition
  // const words = ["hello", "test", "javascript"];
  // const grammar = '#JSGF V1.0; grammar words; public <word> = ' + words.join(' | ') + ' ;';
  // const grammarList = new (window.SpeechGrammarList || window.webkitSpeechGrammarList)();
  // grammarList.addFromString(grammar, 1);
  // const startSpeechButton = document.getElementById('start-speech');
  // const stopSpeechButton = document.getElementById('stop-speech');
  // const transcriptDisplay = document.getElementById('transcript');

  // const speechRec = new p5.SpeechRec('en-US', gotSpeech);
  // speechRec.continuous = true; // keep recognizing
  // speechRec.interimResults = true; // only final results
  // speechRec.maxAlternatives = 10
  // speechRec.rec.maxAlternatives = 10;
  // speechRec.grammars = grammarList;
  // speechRec.rec.grammar = grammarList;

  // startSpeechButton.addEventListener('click', () => {
  //   speechRec.start();
  // });

  // stopSpeechButton.addEventListener('click', () => {
  //   speechRec.stop();
  // });
  // function gotSpeech() {
  //   if (speechRec.resultValue) {
  //     console.log(speechRec);
  //     const said = speechRec.resultString.toLowerCase();
  //     transcriptDisplay.textContent = `Transcript: ${said}`;
  //     words.forEach(word => {
  //       if (said.includes(word)) {
  //         console.log(`Detected word: ${word}`);
  //         const speech = new p5.Speech();
  //         speech.speak(`You said the word ${word}`);
  //       }
  //     });
  //   }
  // }

  // Microphone Volume Visualization
  const startButton = document.getElementById('start');
  const stopButton = document.getElementById('stop');
  const volumeDisplay = document.getElementById('volume');
  let micStream;
  let audioContext;
  let analyser;
  let dataArray;

  startButton.addEventListener('click', async () => {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioContext.createMediaStreamSource(micStream);
    analyser = audioContext.createAnalyser();
    source.connect(analyser);
    analyser.fftSize = 2048;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    visualize();
  });

  stopButton.addEventListener('click', () => {
    micStream.getTracks().forEach(track => track.stop());
    audioContext.close();
  });

  function visualize() {
    analyser.getByteFrequencyData(dataArray);
    const volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
    volumeDisplay.textContent = `Volume: ${volume}`;
    document.body.style.backgroundColor = `rgb(${volume * 10}, 0, 0)`;
    requestAnimationFrame(visualize);
  }
</script>

</html>